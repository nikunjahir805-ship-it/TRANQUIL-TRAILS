{% extends 'admin/base_admin.html' %}
{% load static %}
{% block page_title %}Inventory Control{% endblock %}
{% block page_desc %}Monitor stock levels and manage replenishment.{% endblock %}

{% block content %}
<style>
    /* --- FIX FOR SCROLL BLUR & VISIBILITY --- */
    .fade-in-up {
        /* Ensure content is always crisp and visible */
        opacity: 1 !important;
        transform: none !important;
        -webkit-font-smoothing: antialiased;
        backface-visibility: hidden;
    }

    /* Remove any potential backdrop filters that cause blur on scroll */
    .table-row {
        background: #ffffff !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        /* Force GPU rendering to prevent flickering */
        transform: translateZ(0);
        margin-bottom: 10px;
        display: table-row; /* Ensure it behaves like a standard row */
    }

    /* --- SHARED MODERN TABLE STYLES --- */
    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    
    /* Make Header Sticky so it doesn't get lost, but remove blur */
    .modern-table thead th { 
        color: #888; 
        font-size: 0.85rem; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        padding: 10px 20px; 
        text-align: left;
        position: sticky;
        top: 0;
        background: #f4f7f6; /* Match your admin background color */
        z-index: 10;
    }
    
    .table-row { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border-radius: 8px; transition: 0.2s; }
    .table-row:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    
    .table-row td { padding: 15px 20px; vertical-align: middle; border: none; }
    .table-row td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
    .table-row td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

    /* Product Mini Image */
    .prod-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #f4f4f4; margin-right: 15px; border: 1px solid #eee; }
    
    /* Stock Status Badges */
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-in { background: #e8f5e9; color: #2e7d32; }
    .status-low { background: #fff3e0; color: #ef6c00; }
    .status-out { background: #ffebee; color: #c62828; }

    .filter-chip {
        background: white; border: 1px solid #eee; padding: 8px 16px; border-radius: 20px; 
        font-size: 0.85rem; color: #555; cursor: pointer; transition: 0.2s;
    }
    .filter-chip:hover, .filter-chip.active { background: #2c2c2c; color: white; border-color: #2c2c2c; }

    .stock-input {
        width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-weight: bold;
    }
    .stock-input:focus { border-color: #8b5e3c; outline: none; background: #fffbf7; }

    .btn-update {
        background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 6px; cursor: pointer; color: #555; transition: 0.2s;
    }
    .btn-update:hover { background: #2c2c2c; color: white; border-color: #2c2c2c; }

    /* Fix for form elements in tables */
    .modern-table form { display: contents; }
</style>

<div class="fade-in-up">
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #d4edda; color: #155724; border-left: 4px solid #28a745;">
                <i class="fas fa-check-circle"></i> {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
        <div style="position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
            <input type="text" id="invSearch" placeholder="Search SKU or Name..." 
                   style="padding: 10px 10px 10px 35px; border: 1px solid #eee; border-radius: 8px; width: 280px; outline: none;">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="filter-chip active" onclick="filterTable('all', this)">All Stock</button>
            <button class="filter-chip" onclick="filterTable('low', this)">Low Stock</button>
            <button class="filter-chip" onclick="filterTable('out', this)">Out of Stock</button>
        </div>
    </div>

    <table class="modern-table">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Stock Level</th>
                <th>Status</th>
                <th style="text-align: right;">Action</th>
            </tr>
        </thead>
        <tbody id="inventoryBody">
            {% for p in products %}
            <tr class="table-row" 
                data-stock="{{ p.stock|default:0 }}" 
                data-name="{{ p.name|lower }}"
                data-sku="SKU-{{ p.id }}"> 
                
                <td>
                    <div style="display: flex; align-items: center;">
                        {% if p.image %}
                            <img src="{{ p.image.url }}" class="prod-thumb">
                        {% else %}
                            <div class="prod-thumb" style="display:flex; align-items:center; justify-content:center;"><i class="fas fa-box" style="color:#ccc;"></i></div>
                        {% endif %}
                        <span style="font-weight: 600; color: #333;">{{ p.name }}</span>
                    </div>
                </td>

                <td style="color: #666; font-family: monospace;">SKU-{{ p.id }}00X</td>

                <td style="color: #666;">
                    {% if p.category %}{{ p.category.name }}{% else %}Uncategorized{% endif %}
                </td>

                <form method="POST" action="{% url 'admin_update_stock' p.id %}">
                    {% csrf_token %}
                    <td>
                        <input type="number" name="stock" value="{{ p.stock|default:0 }}" class="stock-input" min="0">
                    </td>

                    <td>
                        {% if p.stock > 10 %}
                            <span class="status-badge status-in">In Stock</span>
                        {% elif p.stock > 0 %}
                            <span class="status-badge status-low">Low Stock</span>
                        {% else %}
                            <span class="status-badge status-out">Out of Stock</span>
                        {% endif %}
                    </td>

                    <td style="text-align: right;">
                        <button type="submit" class="btn-update">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </td>
                </form>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                    No products found in inventory.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // --- 1. ANIMATION ENTRY (MODIFIED TO PREVENT STICKY BLUR) ---
    document.addEventListener("DOMContentLoaded", () => {
        gsap.from(".table-row", {
            opacity: 0,
            y: 10,
            duration: 0.4,
            stagger: 0.03,
            ease: "power1.out",
            clearProps: "all" // CRITICAL: This removes the GSAP styles after animation so they don't interfere with scroll
        });
    });

    // --- 2. SEARCH LOGIC ---
    document.getElementById('invSearch').addEventListener('keyup', function() {
        let val = this.value.toLowerCase();
        let rows = document.querySelectorAll('#inventoryBody tr.table-row');

        rows.forEach(row => {
            let name = row.getAttribute('data-name');
            let sku = row.getAttribute('data-sku').toLowerCase();
            
            if (name.includes(val) || sku.includes(val)) {
                row.style.display = "table-row";
            } else {
                row.style.display = "none";
            }
        });
    });

    // --- 3. FILTER LOGIC (All / Low / Out) ---
    function filterTable(type, btn) {
        document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        let rows = document.querySelectorAll('#inventoryBody tr.table-row');

        rows.forEach(row => {
            let input = row.querySelector('input[name="stock"]');
            let stock = input ? parseInt(input.value) : 0;
            
            if (type === 'all') {
                row.style.display = "table-row";
            } 
            else if (type === 'low') {
                if (stock > 0 && stock <= 10) row.style.display = "table-row";
                else row.style.display = "none";
            } 
            else if (type === 'out') {
                if (stock === 0) row.style.display = "table-row";
                else row.style.display = "none";
            }
        });
    }
</script>
{% endblock %}