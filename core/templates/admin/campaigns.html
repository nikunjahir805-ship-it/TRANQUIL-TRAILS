{% extends 'admin/base_admin.html' %}
{% load static %}

{% block page_title %}Email Campaigns{% endblock %}
{% block page_desc %}Engage your audience with newsletters and updates.{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@300;400;500;600&display=swap');

    /* --- STATS BAR --- */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white; padding: 25px; border-radius: 12px;
        border: 1px solid #f0f0f0; box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        display: flex; align-items: center; gap: 20px;
        transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }

    .stat-icon {
        width: 50px; height: 50px; border-radius: 50%;
        background: #fff4e6; color: #8b5e3c;
        display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    .stat-info h3 { font-family: 'Playfair Display'; font-size: 1.8rem; margin: 0; color: #2c2c2c; }
    .stat-info p { font-family: 'Poppins'; font-size: 0.85rem; color: #888; margin: 0; }

    /* --- MAIN LAYOUT --- */
    .campaign-container {
        background: white; border-radius: 16px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.05); overflow: hidden;
        border: 1px solid #eee;
    }

    .toolbar {
        padding: 20px 30px; border-bottom: 1px solid #f0f0f0;
        display: flex; justify-content: space-between; align-items: center;
        background: #fafafa;
    }

    .btn-create {
        background: #2c2c2c; color: white; padding: 12px 25px; border-radius: 30px;
        border: none; font-family: 'Poppins'; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; gap: 10px; transition: 0.3s;
    }
    .btn-create:hover { background: #8b5e3c; transform: scale(1.05); }

    /* --- CAMPAIGN LIST --- */
    .campaign-list { padding: 0; margin: 0; list-style: none; }
    
    .campaign-item {
        display: grid; grid-template-columns: 60px 2fr 1fr 1fr 100px;
        align-items: center; padding: 20px 30px; border-bottom: 1px solid #f9f9f9;
        transition: 0.2s;
    }
    .campaign-item:last-child { border-bottom: none; }
    .campaign-item:hover { background: #fdfdfd; }

    .camp-icon {
        width: 40px; height: 40px; border-radius: 8px; background: #f0f0f0;
        display: flex; align-items: center; justify-content: center; color: #999;
    }
    
    .camp-details h4 { font-family: 'Poppins'; font-size: 1rem; color: #333; margin-bottom: 4px; font-weight: 600; }
    .camp-details p { font-size: 0.8rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }

    .camp-status span {
        padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
    }
    .status-sent { background: #e8f5e9; color: #2e7d32; }
    .status-draft { background: #f5f5f5; color: #616161; }

    .camp-date { font-size: 0.85rem; color: #666; }

    /* --- MODAL --- */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        display: none; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .modal-backdrop.active { display: flex; opacity: 1; }

    .compose-box {
        background: white; width: 600px; border-radius: 16px; padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2); transform: scale(0.95); transition: 0.3s;
    }
    .modal-backdrop.active .compose-box { transform: scale(1); }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-family:'Poppins'; font-weight:600; font-size:0.85rem; margin-bottom:8px; color:#444; }
    .form-input, .form-textarea {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
        font-family: 'Poppins'; font-size: 0.95rem; background: #fafafa;
    }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: #8b5e3c; background: white; }

    .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
    .btn-send { background: #8b5e3c; color: white; padding: 12px 30px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .btn-send:hover { background: #2c2c2c; }
    .btn-draft { background: none; border: 1px solid #ddd; padding: 12px 20px; border-radius: 8px; color: #666; cursor: pointer; }
    
    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; }
    .toast { background: white; padding: 15px 20px; border-radius: 8px; border-left: 4px solid #28a745; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.4s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
</style>

<div class="toast-container">
    {% if messages %}
        {% for message in messages %}
            <div class="toast">
                <i class="fas fa-check-circle" style="color:#28a745"></i>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}
</div>

<div class="fade-in-up">
    
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info">
                <h3>{{ subscriber_count }}</h3>
                <p>Total Subscribers</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
            <div class="stat-info">
                <h3>{{ sent_count }}</h3>
                <p>Campaigns Sent</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-envelope-open"></i></div>
            <div class="stat-info">
                <h3>42%</h3> <p>Avg. Open Rate</p>
            </div>
        </div>
    </div>

    <div class="campaign-container">
        <div class="toolbar">
            <h3 style="font-family:'Playfair Display'; margin:0; font-size:1.5rem;">Recent Campaigns</h3>
            <button class="btn-create" onclick="openModal()">
                <i class="fas fa-plus"></i> New Campaign
            </button>
        </div>

        <div class="campaign-list">
            {% for c in campaigns %}
            <div class="campaign-item">
                <div class="camp-icon">
                    {% if c.status == 'Sent' %}
                        <i class="fas fa-check-circle" style="color:#28a745;"></i>
                    {% else %}
                        <i class="fas fa-pencil-alt"></i>
                    {% endif %}
                </div>
                
                <div class="camp-details">
                    <h4>{{ c.subject }}</h4>
                    <p>{{ c.content|truncatechars:50 }}</p>
                </div>

                <div class="camp-status">
                    <span class="{% if c.status == 'Sent' %}status-sent{% else %}status-draft{% endif %}">
                        {{ c.status }}
                    </span>
                </div>

                <div class="camp-date">
                    {% if c.sent_date %}
                        {{ c.sent_date|date:"M d, Y" }}
                    {% else %}
                        {{ c.created_at|date:"M d, Y" }}
                    {% endif %}
                </div>

                <div style="text-align:right;">
                    <button style="border:none; background:none; cursor:pointer; color:#bbb;"><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 60px; color: #999;">
                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                <p>No campaigns yet. Start writing one!</p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<div class="modal-backdrop" id="composeModal">
    <div class="compose-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:25px;">
            <h2 style="font-family:'Playfair Display'; margin:0;">Compose Email</h2>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label class="form-label">Subject Line</label>
                <input type="text" name="subject" class="form-input" placeholder="e.g. New Collection Arrival!" required>
            </div>

            <div class="form-group">
                <label class="form-label">Email Content</label>
                <textarea name="content" class="form-textarea" rows="8" placeholder="Write your message here..." required></textarea>
            </div>

            <div class="modal-footer">
                <button type="submit" name="action" value="draft" class="btn-draft">Save Draft</button>
                <button type="submit" name="action" value="send" class="btn-send">
                    <i class="fas fa-paper-plane" style="margin-right:8px;"></i> Send Now
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    // Animations
    document.addEventListener("DOMContentLoaded", () => {
        gsap.to(".fade-in-up", { opacity: 1, y: 0, duration: 0.6, ease: "power2.out" });
        gsap.from(".stat-card", { opacity: 0, y: 20, duration: 0.5, stagger: 0.1, delay: 0.2 });
        gsap.from(".campaign-item", { opacity: 0, x: -20, duration: 0.4, stagger: 0.05, delay: 0.4 });
    });

    // Modal Logic
    function openModal() {
        document.getElementById('composeModal').classList.add('active');
    }
    function closeModal() {
        document.getElementById('composeModal').classList.remove('active');
    }

    // Close on Outside Click
    document.getElementById('composeModal').addEventListener('click', (e) => {
        if(e.target === document.getElementById('composeModal')) closeModal();
    });
</script>

{% endblock %}